{% extends "base.html" %}

{% block content %}
<div class="grid two">
  <div class="card">
    <h2 class="section-title">Weather advice</h2>
    <p class="badge">Live recommendation</p>

    <button class="button" onclick="detectLocation()" style="margin-bottom: 10px;">
      Use my location
    </button>
    <button class="button ghost" onclick="useIpLocation(event)" style="margin-bottom: 15px;">
      Use IP location
    </button>

    <p><strong>Location:</strong> {{ location_label or "By coordinates" }}</p>
    <p><strong>Temperature:</strong> {{ weather.temp }} &deg;C</p>
    <p><strong>Wind:</strong> {{ weather.wind }} km/h</p>

    <div class="warning" style="margin-top: 12px;">
      <strong>Recommendation:</strong> {{ weather.recommendation }}
    </div>

    {% if weather.warnings %}
      <div style="margin-top: 12px;">
        {% for warn in weather.warnings %}
          <div class="warning">{{ warn }}</div>
        {% endfor %}
      </div>
    {% endif %}
  </div>

  <div class="card soft">
    <h3 class="section-title">Coordinates (optional)</h3>

    <form method="post" id="locationForm">
      <div class="form-row">
        <label>Latitude</label>
        <input type="number" step="0.0001" name="lat" value="{{ lat }}">
      </div>

      <div class="form-row">
        <label>Longitude</label>
        <input type="number" step="0.0001" name="lon" value="{{ lon }}">
      </div>

      <button class="button ghost" type="submit">
        Update location
      </button>
    </form>

    <h3 class="section-title" style="margin-top: 20px;">7-day forecast</h3>

    <div class="grid">
      {% for day in weather.forecast[:7] %}
        <div class="card">
          <strong>{{ day.date }}</strong><br>
          Max: {{ day.tmax }} &deg;C, Min: {{ day.tmin }} &deg;C<br>
          Rain: {{ day.rain }} mm
        </div>
      {% endfor %}
    </div>
  </div>
</div>

<script>
function detectLocation() {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      function(position) {
        document.querySelector('input[name="lat"]').value = position.coords.latitude;
        document.querySelector('input[name="lon"]').value = position.coords.longitude;
        document.getElementById("locationForm").submit();
      },
      async function() {
        alert("Geolocation denied. Trying IP location.");
        await submitIpLocation();
      }
    );
  } else {
    alert("Geolocation not supported. Trying IP location.");
    submitIpLocation();
  }
}

function useIpLocation(event) {
  event.preventDefault();
  submitIpLocation();
}

async function submitIpLocation() {
  try {
    const res = await fetch("/api/location/ip");
    if (!res.ok) {
      throw new Error("IP lookup failed");
    }
    const data = await res.json();
    document.querySelector('input[name="lat"]').value = data.lat;
    document.querySelector('input[name="lon"]').value = data.lon;
    document.getElementById("locationForm").submit();
  } catch (err) {
    window.location.href = "/weather?use_ip=1";
  }
}
</script>

{% endblock %}
