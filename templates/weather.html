{% extends "base.html" %}

{% block content %}
<div class="grid two">
  <div class="card">
    <h2 class="section-title">Weather advice</h2>
    <p class="badge">Live recommendation</p>

    <button class="button" onclick="detectLocation()" style="margin-bottom: 10px;">
      Use my location
    </button>
    <button class="button ghost" onclick="showSearchLocations()" style="margin-bottom: 15px;">
      Search location
    </button>
    <p style="font-size: 12px; color: #888; margin: 0;">Tip: "Use my location" is more accurate</p>

    <p style="margin-top: 16px;"><strong>Location:</strong> {{ location_label or "By coordinates" }}</p>
    <p><strong>Temperature:</strong> {{ weather.temp }} &deg;C</p>
    <p><strong>Wind:</strong> {{ weather.wind }} km/h</p>

    <div class="warning" style="margin-top: 12px;">
      <strong>Recommendation:</strong> {{ weather.recommendation }}
    </div>

    {% if weather.warnings %}
      <div style="margin-top: 12px;">
        {% for warn in weather.warnings %}
          <div class="warning">{{ warn }}</div>
        {% endfor %}
      </div>
    {% endif %}
  </div>

  <div class="card soft">
    <h3 class="section-title">Coordinates (optional)</h3>

    <form method="post" id="locationForm">
      <div class="form-row">
        <label>Latitude</label>
        <input type="number" step="0.0001" name="lat" value="{{ lat }}">
      </div>

      <div class="form-row">
        <label>Longitude</label>
        <input type="number" step="0.0001" name="lon" value="{{ lon }}">
      </div>

      <button class="button ghost" type="submit">
        Update location
      </button>
    </form>

    <h3 class="section-title" style="margin-top: 20px;">7-day forecast</h3>

    <div class="grid">
      {% for day in weather.forecast[:7] %}
        <div class="card">
          <strong>{{ day.date }}</strong><br>
          Max: {{ day.tmax }} &deg;C, Min: {{ day.tmin }} &deg;C<br>
          Rain: {{ day.rain }} mm
        </div>
      {% endfor %}
    </div>
  </div>
</div>

<!-- Search Locations Modal -->
<div id="searchModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
  <div style="background: #1a1a1a; border-radius: 8px; width: 90%; max-width: 600px; max-height: 80vh; overflow: auto; padding: 20px; color: #fff;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
      <h2 style="margin: 0;">Search Locations</h2>
      <button style="background: none; border: none; color: #fff; font-size: 24px; cursor: pointer;" onclick="closeSearchModal()">×</button>
    </div>
    
    <input type="text" id="locationSearch" placeholder="Search city or country..." 
           style="width: 100%; padding: 10px; margin-bottom: 20px; background: #2a2a2a; border: 1px solid #444; border-radius: 4px; color: #fff; font-size: 14px;"
           onkeyup="searchLocations(this.value)">
    
    <div id="searchResults" style="max-height: 60vh; overflow-y: auto;">
      <!-- Results will be populated here -->
    </div>
  </div>
</div>

<script>
let searchTimeout;

function showSearchLocations() {
  const modal = document.getElementById('searchModal');
  modal.style.display = 'flex';
  document.getElementById('locationSearch').focus();
}

function closeSearchModal() {
  document.getElementById('searchModal').style.display = 'none';
  document.getElementById('locationSearch').value = '';
  document.getElementById('searchResults').innerHTML = '';
}

async function searchLocations(query) {
  if (!query || query.length < 2) {
    document.getElementById('searchResults').innerHTML = '';
    return;
  }

  clearTimeout(searchTimeout);
  searchTimeout = setTimeout(async () => {
    try {
      const res = await fetch(`/api/location/search?q=${encodeURIComponent(query)}`);
      if (res.ok) {
        const data = await res.json();
        const results = data.results || [];
        displaySearchResults(results);
      }
    } catch (e) {
      console.error("Location search failed:", e);
    }
  }, 300);
}

function displaySearchResults(results) {
  const container = document.getElementById('searchResults');
  if (!results || results.length === 0) {
    container.innerHTML = '<p style="color: #888;">No results found</p>';
    return;
  }

  let html = '';
  for (const result of results) {
    const display = result.city ? `${result.city}, ${result.country}` : result.country;
    html += `
      <div style="padding: 12px; border-bottom: 1px solid #333; cursor: pointer; hover: background: #2a2a2a;" 
           onmouseover="this.style.background='#2a2a2a'" 
           onmouseout="this.style.background='transparent'"
           onclick="selectLocation(${result.lat}, ${result.lon}, '${display}')">
        <strong>${display}</strong><br>
        <small style="color: #888;">${result.lat.toFixed(2)}°N ${result.lon.toFixed(2)}°E</small>
      </div>
    `;
  }

  container.innerHTML = html;
}

function selectLocation(lat, lon, display) {
  document.querySelector('input[name="lat"]').value = lat;
  document.querySelector('input[name="lon"]').value = lon;
  closeSearchModal();
  
  // Submit the form with the selected location
  document.getElementById("locationForm").action = "/weather";
  document.getElementById("locationForm").submit();
}

async function getLocationNameByCoords(lat, lon) {
  try {
    const res = await fetch(`/api/location/reverse?lat=${lat}&lon=${lon}`);
    if (res.ok) {
      return await res.json();
    }
  } catch (e) {
    console.error("Reverse geocoding failed:", e);
  }
  return null;
}

async function detectLocation() {
  if (!navigator.geolocation) {
    alert("Geolocation not supported. Please search for location manually.");
    return;
  }

  const submitCoords = async (lat, lon) => {
    document.querySelector('input[name="lat"]').value = lat;
    document.querySelector('input[name="lon"]').value = lon;
    
    // Get city and country by coordinates
    const location = await getLocationNameByCoords(lat, lon);
    if (location && location.city) {
      // Submit with location info via query parameter
      const form = document.getElementById("locationForm");
      form.action = "/weather?from_browser=1";
      form.submit();
    } else {
      document.getElementById("locationForm").submit();
    }
  };

  try {
    if (navigator.permissions && navigator.permissions.query) {
      const perm = await navigator.permissions.query({ name: "geolocation" });
      if (perm.state === "denied") {
        alert("Geolocation denied. Please search for location manually.");
        return;
      }
    }
  } catch (e) {
    // Ignore permission API errors and continue with normal geolocation flow.
  }

  navigator.geolocation.getCurrentPosition(
    function(position) {
      submitCoords(position.coords.latitude, position.coords.longitude);
    },
    function(error) {
      alert("Could not get exact location. Please search for location manually.");
    },
    {
      enableHighAccuracy: false,
      timeout: 7000,
      maximumAge: 300000
    }
  );
