{% extends "base.html" %}

{% block content %}
<div class="grid two">
  <div class="card">
    <h2 class="section-title">Weather advice</h2>
    <p class="badge">Live recommendation</p>

    <button class="button" onclick="detectLocation()" style="margin-bottom: 10px;">
      Use my location
    </button>
    <button class="button ghost" onclick="useIpLocation(event)" style="margin-bottom: 15px;">
      Use IP location (less accurate)
    </button>
    <p style="font-size: 12px; color: #888; margin: 0;">Tip: "Use my location" is more accurate</p>

    <p style="margin-top: 16px;"><strong>Location:</strong> {{ location_label or "By coordinates" }}</p>
    <p><strong>Temperature:</strong> {{ weather.temp }} &deg;C</p>
    <p><strong>Wind:</strong> {{ weather.wind }} km/h</p>

    <div class="warning" style="margin-top: 12px;">
      <strong>Recommendation:</strong> {{ weather.recommendation }}
    </div>

    {% if weather.warnings %}
      <div style="margin-top: 12px;">
        {% for warn in weather.warnings %}
          <div class="warning">{{ warn }}</div>
        {% endfor %}
      </div>
    {% endif %}
  </div>

  <div class="card soft">
    <h3 class="section-title">Coordinates (optional)</h3>

    <form method="post" id="locationForm">
      <div class="form-row">
        <label>Latitude</label>
        <input type="number" step="0.0001" name="lat" value="{{ lat }}">
      </div>

      <div class="form-row">
        <label>Longitude</label>
        <input type="number" step="0.0001" name="lon" value="{{ lon }}">
      </div>

      <button class="button ghost" type="submit">
        Update location
      </button>
    </form>

    <h3 class="section-title" style="margin-top: 20px;">7-day forecast</h3>

    <div class="grid">
      {% for day in weather.forecast[:7] %}
        <div class="card">
          <strong>{{ day.date }}</strong><br>
          Max: {{ day.tmax }} &deg;C, Min: {{ day.tmin }} &deg;C<br>
          Rain: {{ day.rain }} mm
        </div>
      {% endfor %}
    </div>
  </div>
</div>

<script>
async function getLocationNameByCoords(lat, lon) {
  try {
    const res = await fetch(`/api/location/reverse?lat=${lat}&lon=${lon}`);
    if (res.ok) {
      return await res.json();
    }
  } catch (e) {
    console.error("Reverse geocoding failed:", e);
  }
  return null;
}

async function detectLocation() {
  if (!navigator.geolocation) {
    alert("Geolocation not supported. Trying IP location.");
    await submitIpLocation();
    return;
  }

  const submitCoords = async (lat, lon) => {
    document.querySelector('input[name="lat"]').value = lat;
    document.querySelector('input[name="lon"]').value = lon;
    
    // Get city and country by coordinates
    const location = await getLocationNameByCoords(lat, lon);
    if (location && location.city) {
      // Submit with location info via query parameter
      const form = document.getElementById("locationForm");
      form.action = "/weather?from_browser=1";
      form.submit();
    } else {
      document.getElementById("locationForm").submit();
    }
  };

  const fallbackToIp = async (message) => {
    if (message) alert(message);
    await submitIpLocation();
  };

  try {
    if (navigator.permissions && navigator.permissions.query) {
      const perm = await navigator.permissions.query({ name: "geolocation" });
      if (perm.state === "denied") {
        await fallbackToIp("Geolocation denied. Trying IP location.");
        return;
      }
    }
  } catch (e) {
    // Ignore permission API errors and continue with normal geolocation flow.
  }

  navigator.geolocation.getCurrentPosition(
    function(position) {
      submitCoords(position.coords.latitude, position.coords.longitude);
    },
    async function(error) {
      if (error && error.code === error.PERMISSION_DENIED) {
        await fallbackToIp("Geolocation denied. Trying IP location.");
        return;
      }
      await fallbackToIp("Could not get exact location. Trying IP location.");
    },
    {
      enableHighAccuracy: false,
      timeout: 7000,
      maximumAge: 300000
    }
  );
}

function useIpLocation(event) {
  event.preventDefault();
  submitIpLocation();
}

async function submitIpLocation() {
  try {
    const res = await fetch("/api/location/ip");
    if (!res.ok) {
      throw new Error("IP lookup failed");
    }
    const data = await res.json();
    document.querySelector('input[name="lat"]').value = data.lat;
    document.querySelector('input[name="lon"]').value = data.lon;
    document.getElementById("locationForm").submit();
  } catch (err) {
    window.location.href = "/weather?use_ip=1";
  }
}
</script>

{% endblock %}
